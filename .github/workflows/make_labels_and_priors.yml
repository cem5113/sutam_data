name: Make Labels and Priors (SUTAM)

on:
  workflow_dispatch:
    inputs:
      persist:
        description: "Çıktılar nasıl saklansın?"
        type: choice
        options: [artifact, commit, none]
        default: artifact

permissions:
  contents: write
  actions: read

jobs:
  make_labels_and_priors:
    runs-on: ubuntu-latest

    env:
      TZ: "America/Los_Angeles"
      DATA_DIR: .
      OUT_FILE: sf_crime_grid_full_labeled.parquet
      OUT_ZIP:  fr-crime-outputs-parquet.zip

    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Show workspace (quick diag)
        run: |
          set -e
          echo "PWD=$(pwd)"
          ls -lah
          echo "---- Top-level files ----"
          /usr/bin/find . -maxdepth 1 -type f -printf "%p\t%k KB\n" | sort || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          set -e
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas pyarrow numpy
          fi

      - name: Detect input parquet & optional files
        id: detect
        run: |
          set -euo pipefail

          prefer_10="$(
            /usr/bin/find "${DATA_DIR}" -maxdepth 2 -type f -name 'fr_crime_10.parquet' -print -quit
          )" || true
          prefer_09="$(
            /usr/bin/find "${DATA_DIR}" -maxdepth 2 -type f -name 'fr_crime_09.parquet' -print -quit
          )" || true

          if [ -n "${prefer_10}" ]; then
            INPUT="${prefer_10}"
          elif [ -n "${prefer_09}" ]; then
            INPUT="${prefer_09}"
          else
            echo "❌ fr_crime_10.parquet / fr_crime_09.parquet bulunamadı."
            exit 1
          fi

          echo "✅ INPUT=${INPUT}"
          echo "input=${INPUT}" >> "$GITHUB_OUTPUT"

          RH="$(
            /usr/bin/find "${DATA_DIR}" -maxdepth 2 -type f \( -name 'risk_hourly.parquet' -o -name 'risky_hours.parquet' \) -print -quit
          )" || true
          MET="$(
            /usr/bin/find "${DATA_DIR}" -maxdepth 2 -type f -name 'metrics_stacking_ohe.parquet' -print -quit
          )" || true

          if [ -n "${RH}" ]; then echo "risky_hours=${RH}" >> "$GITHUB_OUTPUT"; fi
          if [ -n "${MET}" ]; then echo "metrics=${MET}"     >> "$GITHUB_OUTPUT"; fi

          echo "---- Detect summary ----"
          echo "INPUT: ${INPUT}"
          echo "RISKY: ${RH:-<none>}"
          echo "METRICS: ${MET:-<none>}"

      - name: Generate labels + priors + package
        run: |
          set -euo pipefail
          INPUT="${{ steps.detect.outputs.input }}"
          OUT_PQ="${DATA_DIR}/${OUT_FILE}"
          OUT_ZIP="${DATA_DIR}/${OUT_ZIP}"

          EXTRA_ARGS=()
          if [ -n "${{ steps.detect.outputs.risky_hours }}" ]; then
            EXTRA_ARGS+=( --risky-hours "${{ steps.detect.outputs.risky_hours }}" )
          fi
          if [ -n "${{ steps.detect.outputs.metrics }}" ]; then
            EXTRA_ARGS+=( --metrics     "${{ steps.detect.outputs.metrics }}" )
          fi

          echo "▶️  Running make_labels_and_priors_xl.py ..."
          python -u make_labels_and_priors_xl.py \
            --input       "${INPUT}" \
            --out         "${OUT_PQ}" \
            --tz          America/Los_Angeles \
            --out-dir     "${DATA_DIR}" \
            --package-zip "${OUT_ZIP}" \
            "${EXTRA_ARGS[@]}"

          # Çıktılar gerçekten oluştu mu?
          test -s "${OUT_PQ}" || { echo "❌ Output parquet yok: ${OUT_PQ}"; exit 1; }
          # İstatistik CSV isteğe bağlıdır; yoksa hata vermesin
          if [ -f "${DATA_DIR}/y_label_stats.csv" ]; then
            echo "Y_label stats:"
            cat "${DATA_DIR}/y_label_stats.csv" || true
          fi

          echo "---- Outputs ----"
          ls -lh "${OUT_PQ}" || true
          ls -lh "${OUT_ZIP}" || true

      - name: Upload artifact (if selected)
        if: ${{ github.event.inputs.persist == 'artifact' }}
        uses: actions/upload-artifact@v4
        with:
          name: fr-crime-outputs-parquet
          path: |
            ${{ env.DATA_DIR }}/${{ env.OUT_FILE }}
            ${{ env.DATA_DIR }}/${{ env.OUT_ZIP }}
            ${{ env.DATA_DIR }}/y_label_stats.csv
          if-no-files-found: warn
          retention-days: 14

      - name: Commit outputs (if selected)
        if: ${{ github.event.inputs.persist == 'commit' }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${DATA_DIR}/${OUT_FILE}" || true
          git add "${DATA_DIR}/${OUT_ZIP}"  || true
          [ -f "${DATA_DIR}/y_label_stats.csv" ] && git add "${DATA_DIR}/y_label_stats.csv" || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: add ${OUT_FILE}, ${OUT_ZIP} and y_label_stats.csv (auto)"
          CURRENT_BRANCH="${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD)}"
          git push origin "${CURRENT_BRANCH}"

      - name: Job summary
        run: |
          set -e
          {
            echo "## Make Labels and Priors — Özet"
            echo ""
            echo "- Input: \`${{ steps.detect.outputs.input }}\`"
            if [ -n "${{ steps.detect.outputs.risky_hours }}" ]; then
              echo "- risky_hours: \`${{ steps.detect.outputs.risky_hours }}\`"
            fi
            if [ -n "${{ steps.detect.outputs.metrics }}" ]; then
              echo "- metrics: \`${{ steps.detect.outputs.metrics }}\`"
            fi
            echo "- Output Parquet: \`${{ env.DATA_DIR }}/${{ env.OUT_FILE }}\`"
            echo "- Output ZIP: \`${{ env.DATA_DIR }}/${{ env.OUT_ZIP }}\`"
            if [ -f "${{ env.DATA_DIR }}/y_label_stats.csv" ]; then
              echo ""
              echo "### Y_label dağılımı"
              tail -n +1 "${{ env.DATA_DIR }}/y_label_stats.csv"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
